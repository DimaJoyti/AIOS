{
  "name": "AIOS Development Environment",
  "dockerComposeFile": [
    "../deployments/docker-compose.dev.yml",
    "docker-compose.devcontainer.yml"
  ],
  "service": "devcontainer",
  "workspaceFolder": "/workspace",
  "shutdownAction": "stopCompose",

  // Features to install
  "features": {
    "ghcr.io/devcontainers/features/common-utils:2": {
      "installZsh": true,
      "configureZshAsDefaultShell": true,
      "installOhMyZsh": true,
      "upgradePackages": true,
      "username": "vscode",
      "userUid": "1000",
      "userGid": "1000"
    },
    "ghcr.io/devcontainers/features/go:1": {
      "version": "1.23",
      "golangciLintVersion": "latest"
    },
    "ghcr.io/devcontainers/features/node:1": {
      "version": "18",
      "nodeGypDependencies": true,
      "installYarnUsingApt": true
    },
    "ghcr.io/devcontainers/features/docker-in-docker:2": {
      "version": "latest",
      "enableNonRootDocker": true,
      "moby": true
    },
    "ghcr.io/devcontainers/features/kubectl-helm-minikube:1": {
      "version": "latest",
      "helm": "latest",
      "minikube": "latest"
    },
    "ghcr.io/devcontainers/features/github-cli:1": {
      "installDirectlyFromGitHubRelease": true,
      "version": "latest"
    }
  },

  // VS Code settings
  "customizations": {
    "vscode": {
      "settings": {
        "go.toolsManagement.checkForUpdates": "local",
        "go.useLanguageServer": true,
        "go.gopath": "/go",
        "go.goroot": "/usr/local/go",
        "go.lintTool": "golangci-lint",
        "go.lintFlags": ["--fast"],
        "go.formatTool": "goimports",
        "go.testFlags": ["-v", "-race"],
        "go.coverOnSave": true,
        "go.coverOnSingleTest": true,
        "go.coverageDecorator": {
          "type": "gutter",
          "coveredHighlightColor": "rgba(64,128,128,0.5)",
          "uncoveredHighlightColor": "rgba(128,64,64,0.25)"
        },
        "editor.formatOnSave": true,
        "editor.codeActionsOnSave": {
          "source.organizeImports": true
        },
        "files.eol": "\n",
        "files.insertFinalNewline": true,
        "files.trimTrailingWhitespace": true,
        "terminal.integrated.defaultProfile.linux": "zsh",
        "typescript.preferences.importModuleSpecifier": "relative",
        "eslint.workingDirectories": ["web"],
        "prettier.configPath": "web/.prettierrc"
      },
      
      "extensions": [
        // Go development
        "golang.go",
        "ms-vscode.vscode-go",
        
        // TypeScript/React development
        "ms-vscode.vscode-typescript-next",
        "bradlc.vscode-tailwindcss",
        "esbenp.prettier-vscode",
        "dbaeumer.vscode-eslint",
        
        // Docker and Kubernetes
        "ms-azuretools.vscode-docker",
        "ms-kubernetes-tools.vscode-kubernetes-tools",
        
        // Git and GitHub
        "github.vscode-pull-request-github",
        "github.copilot",
        "github.copilot-chat",
        
        // General development
        "ms-vscode.vscode-json",
        "redhat.vscode-yaml",
        "ms-vscode.makefile-tools",
        "gruntfuggly.todo-tree",
        "streetsidesoftware.code-spell-checker",
        
        // Testing
        "hbenl.vscode-test-explorer",
        "ms-vscode.test-adapter-converter",
        
        // Productivity
        "ms-vscode.vscode-thunder-client",
        "humao.rest-client",
        "ms-vscode.hexeditor",
        
        // AI and Documentation
        "ms-toolsai.jupyter",
        "yzhang.markdown-all-in-one",
        "davidanson.vscode-markdownlint"
      ]
    }
  },

  // Port forwarding
  "forwardPorts": [
    8080,  // AIOS Daemon API
    9090,  // Prometheus Metrics
    3000,  // Next.js Dev Server
    5432,  // PostgreSQL
    6379,  // Redis
    8081,  // AIOS Assistant
    8082   // AIOS Desktop
  ],

  "portsAttributes": {
    "8080": {
      "label": "AIOS Daemon API",
      "onAutoForward": "notify"
    },
    "9090": {
      "label": "Prometheus Metrics",
      "onAutoForward": "silent"
    },
    "3000": {
      "label": "Next.js Dev Server",
      "onAutoForward": "openBrowser"
    },
    "5432": {
      "label": "PostgreSQL",
      "onAutoForward": "silent"
    },
    "6379": {
      "label": "Redis",
      "onAutoForward": "silent"
    }
  },

  // Environment variables
  "containerEnv": {
    "AIOS_ENV": "development",
    "AIOS_LOG_LEVEL": "debug",
    "GO111MODULE": "on",
    "GOPROXY": "https://proxy.golang.org,direct",
    "GOSUMDB": "sum.golang.org"
  },

  // Lifecycle scripts
  "postCreateCommand": "bash .devcontainer/post-create.sh",
  "postStartCommand": "bash .devcontainer/post-start.sh",

  // Mount the local git config and ssh keys
  "mounts": [
    "source=${localEnv:HOME}/.gitconfig,target=/home/vscode/.gitconfig,type=bind,consistency=cached",
    "source=${localEnv:HOME}/.ssh,target=/home/vscode/.ssh,type=bind,consistency=cached"
  ],

  // Run as non-root user
  "remoteUser": "vscode",
  "updateRemoteUserUID": true,

  // Additional container arguments
  "runArgs": [
    "--init",
    "--privileged"
  ]
}
